<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Auto Handoff Generator</title>
  <style>
    :root {
      --accent: #4668FF;
      --accent-light: #dbeafe;
      --accent-hover: #2563eb;
      --bg-primary: #fafaf9;
      --bg-secondary: #f5f5f4;
      --bg-tertiary: #ffffff;
      --text-primary: #1c1917;
      --text-secondary: #57534e;
      --text-tertiary: #78716c;
      --border-light: rgba(0, 0, 0, 0.06);
      --border-medium: rgba(0, 0, 0, 0.08);
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.06);
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      font-size: 11px;
      color: var(--text-primary);
      background: var(--bg-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-light);
      position: relative;
    }

    .header-refresh {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: var(--radius-md);
      transition: var(--transition);
      color: var(--text-tertiary);
    }

    .header-refresh:hover {
      background: var(--bg-secondary);
      color: var(--accent);
    }

    .header-refresh svg {
      width: 16px;
      height: 16px;
    }

    .header-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-light) 0%, #e0f2f1 100%);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
      font-size: 20px;
      font-weight: 400;
      color: var(--accent);
    }

    .header-icon svg {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }

    .header-info {
      flex: 1;
      min-width: 0;
    }

    .header-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: -0.01em;
    }

    .header-subtitle {
      font-size: 10px;
      color: var(--text-tertiary);
      margin-top: 2px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 2px;
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-light);
    }

    .tab {
      padding: 7px 14px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: var(--radius-md);
      transition: var(--transition);
      position: relative;
    }

    .tab:hover {
      color: var(--text-primary);
      background: var(--bg-secondary);
    }

    .tab.active {
      color: var(--accent);
      background: linear-gradient(135deg, var(--accent-light) 0%, #e0f2f1 100%);
    }

    /* Content */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px 16px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Section Item */
    .section-item {
      padding: 12px;
      margin-bottom: 8px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .section-item:hover {
      box-shadow: var(--shadow-md);
    }

    .section-item:last-child {
      margin-bottom: 0;
    }

    .section-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .section-icon {
      width: 18px;
      height: 18px;
      color: var(--text-tertiary);
      flex-shrink: 0;
      margin-top: 1px;
      transition: var(--transition);
    }

    .section-item.active .section-icon {
      color: var(--accent);
    }

    .section-info {
      flex: 1;
      min-width: 0;
    }

    .section-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-primary);
      letter-spacing: -0.01em;
    }

    .section-description {
      font-size: 10px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    .section-toggle-link {
      font-size: 10px;
      color: #2563eb;
      cursor: pointer;
      margin-top: 4px;
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-weight: 500;
      transition: var(--transition);
    }

    .section-toggle-link:hover {
      color: var(--accent);
    }

    .section-toggle-link svg {
      width: 10px;
      height: 10px;
      transition: transform 0.25s ease;
    }

    .section-toggle-link.expanded svg {
      transform: rotate(180deg);
    }

    /* Toggle Switch - Compact */
    .toggle-switch {
      position: relative;
      width: 32px;
      height: 18px;
      flex-shrink: 0;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border-medium);
      transition: var(--transition);
      border-radius: 18px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: var(--transition);
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
    }

    input:checked+.toggle-slider {
      background-color: var(--accent);
    }

    input:checked+.toggle-slider:before {
      transform: translateX(14px);
    }

    /* Section Options (expandable) */
    .section-options {
      display: none;
      margin-top: 12px;
      margin-left: 28px;
      padding: 12px;
      background: #fafaf9;
      border-radius: var(--radius-md);
    }

    .section-options.expanded {
      display: block;
    }

    /* View Mode Selector */
    .view-mode-label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 8px;
    }

    .view-mode-buttons {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
    }

    .view-mode-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 6px 10px;
      background: var(--bg-tertiary);
      border: none;
      border-radius: var(--radius-md);
      font-size: 10px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }

    .view-mode-btn:hover {
      background: var(--bg-tertiary);
      box-shadow: var(--shadow-md);
    }

    .view-mode-btn.selected {
      background: var(--accent-light);
      color: var(--accent);
    }

    .view-mode-btn svg {
      width: 12px;
      height: 12px;
    }

    .view-mode-btn .check-icon {
      width: 12px;
      height: 12px;
      display: none;
    }

    .view-mode-btn.selected .check-icon {
      display: block;
    }

    /* Variant Filters */
    .variant-filters-label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 8px;
    }

    .variant-accordion {
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      overflow: hidden;
      margin-bottom: 6px;
      box-shadow: var(--shadow-sm);
    }

    .variant-accordion:last-child {
      margin-bottom: 0;
    }

    .variant-accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      cursor: pointer;
      transition: var(--transition);
    }

    .variant-accordion-header:hover {
      background: var(--bg-secondary);
    }

    .variant-accordion-title {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .variant-accordion-chevron {
      width: 12px;
      height: 12px;
      color: var(--text-tertiary);
      transition: transform 0.25s ease;
    }

    .variant-accordion.expanded .variant-accordion-chevron {
      transform: rotate(180deg);
    }

    .variant-accordion-content {
      display: none;
      padding: 0 8px 8px;
    }

    .variant-accordion.expanded .variant-accordion-content {
      display: block;
    }

    .variant-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      margin-bottom: 4px;
      cursor: pointer;
      transition: var(--transition);
    }

    .variant-chip:last-child {
      margin-bottom: 0;
    }

    .variant-chip:hover {
      background: var(--border-medium);
    }

    .variant-chip.selected {
      background: linear-gradient(135deg, var(--accent-light) 0%, #e0f2f1 100%);
    }

    .variant-chip input {
      display: none;
    }

    .variant-chip-check {
      width: 14px;
      height: 14px;
      border: 1.5px solid var(--text-tertiary);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: var(--transition);
    }

    .variant-chip.selected .variant-chip-check {
      background: var(--accent);
      border-color: var(--accent);
    }

    .variant-chip-check svg {
      width: 9px;
      height: 9px;
      color: white;
      display: none;
    }

    .variant-chip.selected .variant-chip-check svg {
      display: block;
    }

    .variant-chip-label {
      font-size: 10px;
      color: var(--text-secondary);
    }

    .variant-chip.selected .variant-chip-label {
      color: var(--accent-hover);
    }

    /* Grid Density Setting */
    .grid-density-setting {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-light);
    }

    .grid-density-setting:first-child {
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }

    .grid-density-label {
      font-size: 10px;
      color: var(--text-secondary);
    }

    .grid-density-input {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .grid-density-input input {
      width: 48px;
      padding: 5px 8px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 11px;
      text-align: center;
      color: var(--text-primary);
      background: var(--bg-tertiary);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .grid-density-input input:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent-light);
    }

    /* Checkbox Option */
    .checkbox-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      margin-top: 8px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .checkbox-option:hover {
      box-shadow: var(--shadow-md);
    }

    .checkbox-box {
      width: 16px;
      height: 16px;
      border: 1.5px solid var(--text-tertiary);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: var(--transition);
    }

    .checkbox-option.checked .checkbox-box {
      background: var(--accent);
      border-color: var(--accent);
    }

    .checkbox-box svg {
      width: 10px;
      height: 10px;
      color: white;
      display: none;
    }

    .checkbox-option.checked .checkbox-box svg {
      display: block;
    }

    .checkbox-label {
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* Layout Settings */
    .layout-setting {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      margin-bottom: 8px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    .layout-setting:last-child {
      margin-bottom: 0;
    }

    .layout-setting-label {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .layout-setting-input {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .layout-setting-input input {
      width: 64px;
      padding: 6px 8px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 11px;
      text-align: right;
      color: var(--text-primary);
      background: var(--bg-secondary);
      transition: var(--transition);
    }

    .layout-setting-input input:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent-light);
    }

    .layout-setting-unit {
      font-size: 10px;
      color: var(--text-tertiary);
    }

    /* Color input */
    .color-input {
      position: relative;
    }

    .color-input .color-hash {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-right: 2px;
    }

    .color-input input {
      width: 68px;
      text-align: left;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .color-preview {
      width: 22px;
      height: 22px;
      border-radius: var(--radius-sm);
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
      margin-left: 8px;
    }

    /* Assets Tab */
    .assets-editing-banner {
      background: linear-gradient(135deg, var(--accent-light) 0%, #e0f2f1 100%);
      padding: 12px;
      border-radius: var(--radius-lg);
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .assets-editing-banner.active {
      display: flex;
    }

    .assets-editing-banner svg {
      width: 16px;
      height: 16px;
      color: var(--accent);
      flex-shrink: 0;
    }

    .assets-editing-banner-text {
      flex: 1;
      font-size: 11px;
      color: var(--accent-hover);
      font-weight: 500;
    }

    .assets-section {
      margin-bottom: 20px;
    }

    .assets-section-title {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 10px;
    }

    .assets-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }

    .assets-grid-medida {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .asset-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      padding: 12px 8px;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      box-shadow: var(--shadow-sm);
    }

    .asset-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .asset-card.selected {
      background: var(--accent-light);
      box-shadow: 0 0 0 2px var(--accent);
    }

    .assets-add-section {
      margin-top: 16px;
      text-align: center;
    }

    .assets-add-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--accent);
      font-size: 12px;
      font-weight: 500;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: var(--radius-lg);
      transition: var(--transition);
      background: var(--accent-light);
    }

    .assets-add-link:hover {
      background: var(--accent);
      color: white;
    }

    .assets-add-link svg {
      flex-shrink: 0;
    }

    .asset-preview {
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 6px;
    }

    .asset-label {
      font-size: 10px;
      color: var(--text-secondary);
    }

    /* Measure preview */
    .measure-preview {
      flex-direction: column;
      gap: 3px;
    }

    .measure-line {
      width: 44px;
      height: 2px;
      background: #e11d48;
      position: relative;
    }

    .measure-line::before,
    .measure-line::after {
      content: '';
      position: absolute;
      width: 2px;
      height: 8px;
      background: #e11d48;
      top: -3px;
    }

    .measure-line::before {
      left: 0;
    }

    .measure-line::after {
      right: 0;
    }

    .measure-badge {
      background: #e11d48;
      color: white;
      font-size: 8px;
      font-weight: 500;
      padding: 2px 5px;
      border-radius: 3px;
    }

    /* Gap preview */
    .gap-preview {
      flex-direction: column;
      gap: 3px;
    }

    .gap-area {
      width: 44px;
      height: 16px;
      background: rgba(217, 70, 239, 0.15);
      border: 1px dashed #d946ef;
      border-radius: 2px;
    }

    .gap-badge {
      background: #d946ef;
      color: white;
      font-size: 8px;
      font-weight: 500;
      padding: 2px 5px;
      border-radius: 3px;
    }

    /* Padding preview */
    .padding-preview {
      flex-direction: column;
      gap: 3px;
    }

    .padding-area {
      width: 44px;
      height: 16px;
      background: rgba(14, 165, 233, 0.15);
      border: 1px dashed #0ea5e9;
      border-radius: 2px;
    }

    .padding-badge {
      background: #0ea5e9;
      color: white;
      font-size: 8px;
      font-weight: 500;
      padding: 2px 5px;
      border-radius: 3px;
    }

    /* Pointer preview */
    .pointer-preview {
      display: flex;
      flex-direction: column;
      gap: 0px;
      align-items: center;
      justify-content: center;
    }

    .pointer-preview.pointer-horizontal {
      flex-direction: row;
      gap: 0px;
    }

    .pointer-preview.pointer-bottom {
      flex-direction: column;
    }

    .pointer-dot {
      width: 6px;
      height: 6px;
      background: #e11d48;
      border-radius: 50%;
    }

    .pointer-line-v {
      width: 1px;
      height: 12px;
      background: #e11d48;
    }

    .pointer-line-h {
      width: 12px;
      height: 1px;
      background: #e11d48;
    }

    .pointer-label {
      font-size: 8px;
      color: #e11d48;
    }

    /* Asset options */
    .asset-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .asset-options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 10px;
    }

    .asset-options-grid-compact {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .asset-option-compact {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .asset-option-compact label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .asset-option-compact input,
    .asset-option-compact select {
      width: 100%;
      padding: 7px 10px;
      font-size: 11px;
      border: none;
      border-radius: var(--radius-md);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .asset-option-full {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .asset-option-full input,
    .asset-option-full select {
      width: 100%;
      padding: 9px 12px;
      font-size: 12px;
      border: none;
      border-radius: var(--radius-md);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .asset-option-compact input:focus,
    .asset-option-compact select:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent-light);
    }

    .asset-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .asset-option label {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .asset-option-checkbox {
      justify-content: flex-start;
      margin-top: 8px;
    }

    .asset-option-checkbox .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .asset-option-checkbox input[type="checkbox"] {
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .asset-option input,
    .asset-option select {
      width: 140px;
      padding: 6px 8px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 11px;
      background: var(--bg-secondary);
    }

    .asset-option input:focus,
    .asset-option select:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent-light);
    }

    /* Footer */
    .footer {
      padding: 12px 16px 14px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border-light);
    }

    .footer-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-cancel {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 11px 16px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: none;
      border-radius: var(--radius-lg);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      letter-spacing: 0.01em;
    }

    .btn-cancel:hover {
      background: var(--border-medium);
      color: var(--text-primary);
    }

    .btn-cancel svg {
      width: 14px;
      height: 14px;
    }

    .btn-generate {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 11px 16px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
      letter-spacing: 0.01em;
    }

    .btn-generate:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
    }

    .btn-generate:active {
      transform: translateY(0);
    }

    .btn-generate:disabled {
      background: var(--text-tertiary);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-generate svg {
      width: 14px;
      height: 14px;
    }

    /* Scrollbar */
    .content::-webkit-scrollbar {
      width: 6px;
    }

    .content::-webkit-scrollbar-track {
      background: transparent;
    }

    .content::-webkit-scrollbar-thumb {
      background: var(--border-medium);
      border-radius: 3px;
    }

    .content::-webkit-scrollbar-thumb:hover {
      background: var(--text-tertiary);
    }

    /* === NEW COMPACT ASSETS STYLES === */

    /* Compact Asset Buttons */
    .compact-asset-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 10px;
    }

    .compact-asset-buttons.four-cols {
      grid-template-columns: repeat(4, 1fr);
    }

    .compact-asset-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      padding: 10px 8px;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .compact-asset-btn:hover {
      background: var(--bg-secondary);
      box-shadow: var(--shadow-md);
    }

    .compact-asset-btn.selected {
      background: var(--accent-light);
      border-color: var(--accent);
    }

    .compact-asset-btn-icon {
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .compact-asset-btn-label {
      font-size: 9px;
      color: var(--text-secondary);
    }

    /* Compact Controls */
    .compact-controls-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }

    .compact-control-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .compact-control-label {
      font-size: 9px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .compact-control-select {
      width: 100%;
      padding: 8px 10px;
      font-size: 11px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-sm);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
    }

    .compact-control-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-light);
    }

    /* Color Picker Inline */
    .compact-color-picker-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .compact-color-preview {
      width: 18px;
      height: 18px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-medium);
      flex-shrink: 0;
    }

    .compact-color-input-wrapper {
      display: none;
      margin-top: 4px;
      align-items: center;
      gap: 6px;
    }

    .compact-color-input-wrapper.visible {
      display: flex;
    }

    .compact-color-picker-native {
      width: 32px;
      height: 24px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-sm);
      cursor: pointer;
      padding: 0;
    }

    .compact-color-picker-square {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-sm);
      cursor: pointer;
      padding: 0;
    }

    .compact-color-picker-square::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    .compact-color-picker-square::-webkit-color-swatch {
      border: none;
      border-radius: 4px;
    }

    .compact-color-hash {
      font-size: 11px;
      color: var(--text-tertiary);
      font-family: 'SF Mono', Monaco, monospace;
    }

    .compact-color-hex-input {
      flex: 1;
      padding: 5px 8px;
      font-size: 10px;
      font-family: 'SF Mono', Monaco, monospace;
      text-transform: uppercase;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-sm);
      background: var(--bg-tertiary);
    }

    .compact-color-hex-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-light);
    }

    /* Apoio Compact Rows */
    .compact-apoio-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-medium);
      margin-bottom: 6px;
    }

    .compact-apoio-icon {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .compact-apoio-controls {
      flex: 1;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .compact-apoio-select {
      flex: 1;
      padding: 5px 8px;
      font-size: 10px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-sm);
      background: var(--bg-tertiary);
    }

    .compact-apoio-color-btn {
      width: 22px;
      height: 22px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-medium);
      cursor: pointer;
      transition: var(--transition);
    }

    .compact-apoio-color-btn:hover {
      box-shadow: var(--shadow-sm);
    }

    .compact-apoio-insert-btn {
      padding: 5px 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition);
    }

    .compact-apoio-insert-btn:hover {
      background: var(--accent-hover);
    }

    /* Footer Highlight Checkbox */
    .compact-footer-highlight {
      margin-top: 16px;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-medium);
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .compact-footer-highlight input {
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .compact-footer-highlight label {
      font-size: 11px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .compact-add-asset-btn {
      width: 100%;
      padding: 10px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .compact-add-asset-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .compact-add-asset-btn:active {
      transform: translateY(0);
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <div class="header-icon" id="headerIcon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
      </svg>
    </div>
    <div class="header-info">
      <div class="header-title" id="componentName">Selecione um componente</div>
      <div class="header-subtitle" id="componentType">-</div>
    </div>
    <div class="header-refresh" onclick="refreshPlugin()" title="Recarregar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <polyline points="23 4 23 10 17 10"></polyline>
        <polyline points="1 20 1 14 7 14"></polyline>
        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
      </svg>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="data">Seções</div>
    <div class="tab" data-tab="layout">Layout</div>
    <div class="tab" data-tab="assets">Assets</div>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Data Tab -->
    <div class="tab-panel active" id="data">
      <!-- Cores -->
      <div class="section-item active" data-section="sectionColors">
        <div class="section-header">
          <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="13.5" cy="6.5" r="0.5" fill="currentColor"></circle>
            <circle cx="17.5" cy="10.5" r="0.5" fill="currentColor"></circle>
            <circle cx="8.5" cy="7.5" r="0.5" fill="currentColor"></circle>
            <circle cx="6.5" cy="12.5" r="0.5" fill="currentColor"></circle>
            <path
              d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z">
            </path>
          </svg>
          <div class="section-info">
            <div class="section-title">Cores</div>
            <div class="section-description">Tabela de Tokens de Cor</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="sectionColors" checked onchange="updateSectionState(this)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <!-- Tipografia -->
      <div class="section-item active" data-section="sectionText">
        <div class="section-header">
          <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="4 7 4 4 20 4 20 7"></polyline>
            <line x1="9" y1="20" x2="15" y2="20"></line>
            <line x1="12" y1="4" x2="12" y2="20"></line>
          </svg>
          <div class="section-info">
            <div class="section-title">Tipografia</div>
            <div class="section-description">Mapeamento de Tokens/Valor de Texto</div>
            <span class="section-toggle-link" onclick="toggleSectionOptions('typography')">
              <span class="toggle-text">Mostrar opções</span>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="sectionText" checked onchange="updateSectionState(this)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="section-options" id="typographyOptions">
          <div class="view-mode-label">Gerar:</div>
          <div class="view-mode-buttons">
            <button type="button" class="view-mode-btn selected" id="textTableBtn"
              onclick="toggleViewMode('text', 'table')">
              <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="3" y1="15" x2="21" y2="15"></line>
                <line x1="9" y1="3" x2="9" y2="21"></line>
              </svg>
              <span>Tabela</span>
            </button>
            <button type="button" class="view-mode-btn selected" id="textCanvasBtn"
              onclick="toggleViewMode('text', 'canvas')">
              <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <span>Visualização</span>
            </button>
          </div>
          <div class="variant-filters-label">Filtrar por variantes:</div>
          <div id="textVariantFilters">
            <!-- Dynamic variant accordions will be inserted here -->
          </div>
          <div class="grid-density-setting">
            <span class="grid-density-label">Componentes por linha</span>
            <div class="grid-density-input">
              <input type="number" id="textFramesPerRow" value="2" min="1" max="8">
            </div>
          </div>
        </div>
      </div>

      <!-- Medidas e Espaçamentos -->
      <div class="section-item active" data-section="sectionSpacing">
        <div class="section-header">
          <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="4" y1="21" x2="4" y2="14"></line>
            <line x1="4" y1="10" x2="4" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12" y2="3"></line>
            <line x1="20" y1="21" x2="20" y2="16"></line>
            <line x1="20" y1="12" x2="20" y2="3"></line>
            <line x1="1" y1="14" x2="7" y2="14"></line>
            <line x1="9" y1="8" x2="15" y2="8"></line>
            <line x1="17" y1="16" x2="23" y2="16"></line>
          </svg>
          <div class="section-info">
            <div class="section-title">Medidas e Espaçamentos</div>
            <div class="section-description">Padding, Gaps, Radius, Size e Stroke</div>
            <span class="section-toggle-link" onclick="toggleSectionOptions('measurements')">
              <span class="toggle-text">Mostrar opções</span>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="sectionSpacing" checked onchange="updateSectionState(this)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="section-options" id="measurementsOptions">
          <div class="view-mode-label">Gerar:</div>
          <div class="view-mode-buttons">
            <button type="button" class="view-mode-btn selected" id="spacingTableBtn"
              onclick="toggleViewMode('spacing', 'table')">
              <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="3" y1="15" x2="21" y2="15"></line>
                <line x1="9" y1="3" x2="9" y2="21"></line>
              </svg>
              <span>Tabela</span>
            </button>
            <button type="button" class="view-mode-btn selected" id="spacingCanvasBtn"
              onclick="toggleViewMode('spacing', 'canvas')">
              <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <span>Visualização</span>
            </button>
          </div>
          <div class="variant-filters-label">Filtrar por variantes:</div>
          <div id="spacingVariantFilters">
            <!-- Dynamic variant accordions will be inserted here -->
          </div>
          <div class="grid-density-setting">
            <span class="grid-density-label">Componentes por linha</span>
            <div class="grid-density-input">
              <input type="number" id="spacingFramesPerRow" value="2" min="1" max="8">
            </div>
          </div>
        </div>
      </div>

      <!-- Efeitos (Shadows, Blur, etc.) -->
      <div class="section-item active" data-section="sectionEffects">
        <div class="section-header">
          <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <circle cx="12" cy="12" r="4"></circle>
            <line x1="4.93" y1="4.93" x2="9.17" y2="9.17"></line>
            <line x1="14.83" y1="14.83" x2="19.07" y2="19.07"></line>
            <line x1="14.83" y1="9.17" x2="19.07" y2="4.93"></line>
            <line x1="4.93" y1="19.07" x2="9.17" y2="14.83"></line>
          </svg>
          <div class="section-info">
            <div class="section-title">Efeitos</div>
            <div class="section-description">Shadows, Blur e outros efeitos</div>
            <span class="section-toggle-link" onclick="toggleSectionOptions('effects')">
              <span class="toggle-text">Mostrar opções</span>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="sectionEffects" checked onchange="updateSectionState(this)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="section-options" id="effectsOptions">
          <div class="view-mode-label">Gerar:</div>
          <div class="view-mode-buttons">
            <button type="button" class="view-mode-btn selected" id="effectsTableBtn"
              onclick="toggleViewMode('effects', 'table')">
              <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="3" y1="15" x2="21" y2="15"></line>
                <line x1="9" y1="3" x2="9" y2="21"></line>
              </svg>
              <span>Tabela</span>
            </button>
            <button type="button" class="view-mode-btn selected" id="effectsCanvasBtn"
              onclick="toggleViewMode('effects', 'canvas')">
              <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <span>Visualização</span>
            </button>
          </div>
          <div class="variant-filters-label">Filtrar por variantes:</div>
          <div id="effectsVariantFilters">
            <!-- Dynamic variant accordions will be inserted here -->
          </div>
          <div class="grid-density-setting">
            <span class="grid-density-label">Componentes por linha</span>
            <div class="grid-density-input">
              <input type="number" id="effectsFramesPerRow" value="2" min="1" max="8">
            </div>
          </div>
        </div>
      </div>

      <!-- Dependências -->
      <div class="section-item active" data-section="sectionComponents">
        <div class="section-header">
          <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M12.5 3.28a1 1 0 0 0-1 0l-7 4a1 1 0 0 0-.5.86V16a1 1 0 0 0 .5.86l7 4a1 1 0 0 0 1 0l7-4a1 1 0 0 0 .5-.86V8a1 1 0 0 0-.5-.86z">
            </path>
            <path d="M12 12v9"></path>
            <path d="m12 12 8-4.5"></path>
            <path d="m12 12-8-4.5"></path>
            <path d="m12 12 8 4.5"></path>
            <path d="m12 12-8 4.5"></path>
          </svg>
          <div class="section-info">
            <div class="section-title">Dependências</div>
            <div class="section-description">Componentes e ícones utilizados</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="sectionComponents" checked onchange="updateSectionState(this)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <!-- Estados -->
      <div class="section-item active" data-section="sectionEstados">
        <div class="section-header">
          <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="1" y="5" width="6" height="14" rx="2"></rect>
            <rect x="9" y="5" width="6" height="14" rx="2"></rect>
            <rect x="17" y="5" width="6" height="14" rx="2"></rect>
          </svg>
          <div class="section-info">
            <div class="section-title">Estados</div>
            <div class="section-description">Visualização de todas as variantes</div>
            <span class="section-toggle-link" onclick="toggleSectionOptions('states')">
              <span class="toggle-text">Mostrar opções</span>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="sectionEstados" checked onchange="updateSectionState(this)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="section-options" id="statesOptions">
          <div class="grid-density-setting" style="margin-top: 0; padding-top: 0; border-top: none;">
            <span class="grid-density-label">Componentes por linha</span>
            <div class="grid-density-input">
              <input type="number" id="gridDensity" value="4" min="1" max="8">
            </div>
          </div>
        </div>
      </div>

      <!-- Propriedades do Componente -->
      <div class="section-item active" data-section="sectionProperties">
        <div class="section-header">
          <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          <div class="section-info">
            <div class="section-title">Propriedades do Componente</div>
            <div class="section-description">Listagem de propriedades e valores</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="sectionProperties" checked onchange="updateSectionState(this)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <!-- On-highlight Option -->
      <div class="checkbox-option" id="highlightOption" onclick="toggleHighlight()">
        <div class="checkbox-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <span class="checkbox-label">On-Highlight (para visualizações)</span>
        <input type="checkbox" id="highlightMode" style="display: none;">
      </div>
    </div>

    <!-- Layout Tab -->
    <div class="tab-panel" id="layout">
      <div class="layout-setting">
        <span class="layout-setting-label">Largura do frame</span>
        <div class="layout-setting-input">
          <input type="number" id="frameWidth" value="1140" min="600" max="2400" step="50">
          <span class="layout-setting-unit">px</span>
        </div>
      </div>
      <div class="layout-setting">
        <span class="layout-setting-label">Padding horizontal</span>
        <div class="layout-setting-input">
          <input type="number" id="paddingHorizontal" value="64" min="0" max="200" step="8">
          <span class="layout-setting-unit">px</span>
        </div>
      </div>
      <div class="layout-setting">
        <span class="layout-setting-label">Espaçamento entre seções</span>
        <div class="layout-setting-input">
          <input type="number" id="sectionSpacingInput" value="48" min="0" max="100" step="8">
          <span class="layout-setting-unit">px</span>
        </div>
      </div>
      <div class="layout-setting">
        <span class="layout-setting-label">Cor de fundo</span>
        <div class="layout-setting-input color-input">
          <span class="color-hash">#</span>
          <input type="text" id="bgColor" value="F4F5F7" maxlength="6" placeholder="F4F5F7"
            oninput="updateColorPreview(this)">
          <div class="color-preview" id="bgColorPreview" style="background-color: #F4F5F7;"></div>
        </div>
      </div>
    </div>

    <!-- Assets Tab REFACTORED -->
    <div class="tab-panel" id="assets">
      <!-- MEDIDAS Section -->
      <div class="assets-section-title" style="margin-top: 0;">MEDIDAS</div>

      <div class="compact-asset-buttons">
        <div class="compact-asset-btn asset-card" data-asset="measure" onclick="selectCompactAsset('measure', this)">
          <div class="compact-asset-btn-icon">
            <div class="measure-line"></div>
          </div>
          <div class="compact-asset-btn-label">Medida</div>
        </div>

        <div class="compact-asset-btn asset-card" data-asset="gap" onclick="selectCompactAsset('gap', this)">
          <div class="compact-asset-btn-icon">
            <div class="gap-area"></div>
          </div>
          <div class="compact-asset-btn-label">Gap</div>
        </div>

        <div class="compact-asset-btn asset-card" data-asset="padding" onclick="selectCompactAsset('padding', this)">
          <div class="compact-asset-btn-icon">
            <div class="padding-area"></div>
          </div>
          <div class="compact-asset-btn-label">Padding</div>
        </div>
      </div>

      <div class="compact-controls-row" id="medidasOptions" style="display: none;">
        <div class="compact-control-group">
          <label class="compact-control-label">Direção</label>
          <select class="compact-control-select" id="assetDirection" onchange="triggerMarkerUpdate()">
            <option value="horizontal">Horizontal</option>
            <option value="vertical">Vertical</option>
          </select>
        </div>
        <div class="compact-control-group">
          <label class="compact-control-label">Posição Badge</label>
          <select class="compact-control-select" id="assetBadgePosition" onchange="triggerMarkerUpdate()">
            <option value="bottom">Abaixo</option>
            <option value="top">Acima</option>
            <option value="left">Esquerda</option>
            <option value="right">Direita</option>
          </select>
        </div>
        <div class="compact-control-group">
          <label class="compact-control-label">Cor</label>
          <input type="color" class="compact-color-picker-square" id="medidasColorPicker" value="#E3111F" oninput="onMedidasColorPickerChange()" title="Personalizar cor">
        </div>
      </div>

      <!-- Section divider -->
      <div style="height: 1px; background: var(--border-light); margin: 16px 0;"></div>

      <!-- POINTERS Section -->
      <div class="assets-section-title">POINTERS</div>

      <div class="compact-asset-buttons four-cols">
        <div class="compact-asset-btn asset-card" data-asset="pointer-top" onclick="selectCompactAsset('pointer-top', this)">
          <div class="compact-asset-btn-icon">
            <div class="pointer-preview">
              <div class="pointer-dot"></div>
              <div class="pointer-line-v"></div>
            </div>
          </div>
          <div class="compact-asset-btn-label">Top</div>
        </div>

        <div class="compact-asset-btn asset-card" data-asset="pointer-bottom" onclick="selectCompactAsset('pointer-bottom', this)">
          <div class="compact-asset-btn-icon">
            <div class="pointer-preview pointer-bottom">
              <div class="pointer-line-v"></div>
              <div class="pointer-dot"></div>
            </div>
          </div>
          <div class="compact-asset-btn-label">Bottom</div>
        </div>

        <div class="compact-asset-btn asset-card" data-asset="pointer-left" onclick="selectCompactAsset('pointer-left', this)">
          <div class="compact-asset-btn-icon">
            <div class="pointer-preview pointer-horizontal">
              <div class="pointer-dot"></div>
              <div class="pointer-line-h"></div>
            </div>
          </div>
          <div class="compact-asset-btn-label">Left</div>
        </div>

        <div class="compact-asset-btn asset-card" data-asset="pointer-right" onclick="selectCompactAsset('pointer-right', this)">
          <div class="compact-asset-btn-icon">
            <div class="pointer-preview pointer-horizontal">
              <div class="pointer-line-h"></div>
              <div class="pointer-dot"></div>
            </div>
          </div>
          <div class="compact-asset-btn-label">Right</div>
        </div>
      </div>

      <div class="compact-controls-row" id="pointersOptions" style="display: none;">
        <div class="compact-control-group">
          <label class="compact-control-label">Cor do Marcador</label>
          <input type="color" class="compact-color-picker-square" id="pointerMarkerColorPicker" value="#e11d48" oninput="onPointerMarkerColorPickerChange()" title="Personalizar cor">
        </div>

        <div class="compact-control-group">
          <label class="compact-control-label">Cor do Texto</label>
          <select class="compact-control-select" id="pointerTextColorSelect" onchange="onPointerTextColorChange()">
            <option value="inherit">Mesma do marcador</option>
            <option value="black">Preto</option>
            <option value="custom">Personalizar</option>
          </select>
        </div>
      </div>

      <!-- Hidden color input for custom text color -->
      <div class="compact-color-input-wrapper" id="pointerTextCustomWrapper" style="margin-top: 8px;">
        <input type="color" class="compact-color-picker-native" id="pointerTextColorPicker" value="#000000" oninput="onPointerTextColorPickerChange()">
        <span class="compact-color-hash">#</span>
        <input type="text" class="compact-color-hex-input" id="pointerTextCustomHex" placeholder="000000" maxlength="6" oninput="onPointerTextCustomInput()">
      </div>

      <!-- Add Asset Button for Medidas/Pointers -->
      <div id="addAssetButtonContainer" style="display: none; margin-top: 12px;">
        <button class="compact-add-asset-btn" onclick="insertCompactAsset()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; margin-right: 6px;">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Adicionar asset no arquivo
        </button>
      </div>

      <!-- Section divider -->
      <div style="height: 1px; background: var(--border-light); margin: 16px 0;"></div>

      <!-- APOIO Section -->
      <div class="assets-section-title">APOIO</div>

      <!-- Pointers Numéricos -->
      <div class="compact-apoio-row">
        <div class="compact-apoio-icon">
          <div style="width: 20px; height: 20px; border-radius: 50%; background: #FCFC30; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; color: #000;">1</div>
        </div>
        <div class="compact-apoio-controls">
          <select class="compact-apoio-select asset-card" id="apoioNumberDirection" data-asset="number-top" onchange="updateApoioNumberSelection()">
            <option value="number-top">Top</option>
            <option value="number-bottom">Bottom</option>
            <option value="number-left">Left</option>
            <option value="number-right">Right</option>
          </select>
          <div class="compact-apoio-color-btn" id="apoioNumberColorBtn" style="background: #FCFC30;" onclick="toggleApoioNumberColorPicker()" title="Personalizar cor"></div>
          <button class="compact-apoio-insert-btn" onclick="insertApoioNumber()">Inserir</button>
        </div>
      </div>

      <!-- Hidden color input for number -->
      <div class="compact-color-input-wrapper" id="apoioNumberCustomWrapper" style="margin-bottom: 8px;">
        <input type="color" class="compact-color-picker-native" id="apoioNumberColorPicker" value="#FCFC30" oninput="onApoioNumberColorPickerChange()">
        <span class="compact-color-hash">#</span>
        <input type="text" class="compact-color-hex-input" id="apoioNumberCustomHex" placeholder="FCFC30" maxlength="6" oninput="onApoioNumberCustomInput()">
      </div>

      <!-- Formas (Assets) -->
      <div class="compact-apoio-row">
        <div class="compact-apoio-icon">
          <div style="width: 20px; height: 20px; border-radius: 50%; background: rgba(218, 160, 176, 0.3); border: 2px dashed #DAA0B0;"></div>
        </div>
        <div class="compact-apoio-controls">
          <select class="compact-apoio-select asset-card" id="apoioAreaType" data-asset="area-dashed-circle" onchange="updateApoioAreaSelection()">
            <option value="area-dashed-circle">Dashed Circle</option>
            <option value="area-dashed-square">Dashed Square</option>
            <option value="area-outline-circle">Outline Circle</option>
            <option value="area-outline-square">Outline Square</option>
            <option value="area-solid-circle">Solid Circle</option>
            <option value="area-solid-square">Solid Square</option>
          </select>
          <div class="compact-apoio-color-btn" id="apoioAreaColorBtn" style="background: #DAA0B0;" onclick="toggleApoioAreaColorPicker()" title="Personalizar cor"></div>
          <button class="compact-apoio-insert-btn" onclick="insertApoioArea()">Inserir</button>
        </div>
      </div>

      <!-- Hidden color input for area -->
      <div class="compact-color-input-wrapper" id="apoioAreaCustomWrapper" style="margin-bottom: 8px;">
        <input type="color" class="compact-color-picker-native" id="apoioAreaColorPicker" value="#DAA0B0" oninput="onApoioAreaColorPickerChange()">
        <span class="compact-color-hash">#</span>
        <input type="text" class="compact-color-hex-input" id="apoioAreaCustomHex" placeholder="DAA0B0" maxlength="6" oninput="onApoioAreaCustomInput()">
      </div>

      <!-- Hidden div for apoioOptions (used by loadMarkerConfig) -->
      <div id="apoioOptions" style="display: none;">
        <select id="apoioVariant"></select>
      </div>

      <!-- Footer Checkbox -->
      <div class="compact-footer-highlight" onclick="toggleGlobalHighlight()">
        <input type="checkbox" id="assetHighlightMode" onchange="triggerMarkerUpdate()">
        <label for="assetHighlightMode">On-Highlight</label>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="footer-buttons">
      <button class="btn-cancel" onclick="closePlugin()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        Cancelar
      </button>
      <button class="btn-generate" id="btnGenerate" onclick="generate()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <polygon points="5 3 19 12 5 21 5 3"></polygon>
        </svg>
        Gerar Especificações
      </button>
    </div>
  </div>

  <script>
    // State management
    let variantProperties = [];
    let isEditingMarker = false; // Track if we're editing an existing marker
    let currentMarkerConfig = null; // Store current marker config

    // View mode state (table/canvas toggles)
    const viewModes = {
      text: { table: true, canvas: true },
      spacing: { table: true, canvas: true },
      effects: { table: true, canvas: true }
    };

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');

        // Hide/show footer based on active tab
        const footer = document.querySelector('.footer');
        if (tab.dataset.tab === 'assets') {
          footer.style.display = 'none';
        } else {
          footer.style.display = 'block';
        }
      });
    });

    // Update section state (icon color)
    function updateSectionState(checkbox) {
      const sectionItem = checkbox.closest('.section-item');
      if (checkbox.checked) {
        sectionItem.classList.add('active');
      } else {
        sectionItem.classList.remove('active');
      }
    }

    // Toggle section options visibility
    window.toggleSectionOptions = function toggleSectionOptions(section) {
      const optionsEl = document.getElementById(section + 'Options');
      const linkEl = optionsEl.previousElementSibling.querySelector('.section-toggle-link');
      const textEl = linkEl.querySelector('.toggle-text');

      optionsEl.classList.toggle('expanded');
      linkEl.classList.toggle('expanded');

      if (optionsEl.classList.contains('expanded')) {
        textEl.textContent = 'Ocultar opções';
      } else {
        textEl.textContent = 'Mostrar opções';
      }
    }

    // Update color preview
    function updateColorPreview(input) {
      // Clean input - only allow hex characters
      input.value = input.value.replace(/[^0-9A-Fa-f]/g, '').toUpperCase();

      const color = input.value;
      const preview = document.getElementById('bgColorPreview');

      // Only update preview if we have a valid 6-char hex or 3-char hex
      if (color.length === 6 || color.length === 3) {
        preview.style.backgroundColor = '#' + color;
      }
    }

    // Toggle view mode (table/canvas)
    window.toggleViewMode = function toggleViewMode(section, mode) {
      viewModes[section][mode] = !viewModes[section][mode];

      let btnId;
      if (section === 'text') {
        btnId = mode === 'table' ? 'textTableBtn' : 'textCanvasBtn';
      } else if (section === 'spacing') {
        btnId = mode === 'table' ? 'spacingTableBtn' : 'spacingCanvasBtn';
      } else if (section === 'effects') {
        btnId = mode === 'table' ? 'effectsTableBtn' : 'effectsCanvasBtn';
      }

      const btn = document.getElementById(btnId);
      btn.classList.toggle('selected', viewModes[section][mode]);
    }

    // Toggle highlight option
    window.toggleHighlight = function toggleHighlight() {
      const option = document.getElementById('highlightOption');
      const checkbox = document.getElementById('highlightMode');
      option.classList.toggle('checked');
      checkbox.checked = option.classList.contains('checked');
    }

    // Toggle variant accordion
    window.toggleVariantAccordion = function toggleVariantAccordion(accordionEl) {
      accordionEl.classList.toggle('expanded');
    }

    // Toggle variant chip selection
    window.toggleVariantChip = function toggleVariantChip(chipEl) {
      chipEl.classList.toggle('selected');
      const checkbox = chipEl.querySelector('input');
      checkbox.checked = chipEl.classList.contains('selected');
    }

    // Render variant filters for a section
    function renderVariantFilters(containerId, properties) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

      if (!properties || properties.length === 0) {
        container.innerHTML = '<div style="font-size: 10px; color: var(--text-tertiary); padding: 6px 0;">Nenhuma propriedade de variante disponível</div>';
        return;
      }

      properties.forEach((prop, propIndex) => {
        const accordion = document.createElement('div');
        accordion.className = 'variant-accordion';
        accordion.innerHTML = `
          <div class="variant-accordion-header" onclick="toggleVariantAccordion(this.parentElement)">
            <span class="variant-accordion-title">${prop.name}</span>
            <svg class="variant-accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="variant-accordion-content">
            ${prop.values.map((value, valueIndex) => `
              <div class="variant-chip selected" onclick="toggleVariantChip(this)">
                <input type="checkbox" checked data-property="${prop.name}" data-value="${value}" data-container="${containerId}">
                <div class="variant-chip-check">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </div>
                <span class="variant-chip-label">${value}</span>
              </div>
            `).join('')}
          </div>
        `;
        container.appendChild(accordion);
      });
    }

    // Render variant properties for both sections
    function renderVariantProperties(properties) {
      variantProperties = properties;
      renderVariantFilters('textVariantFilters', properties);
      renderVariantFilters('spacingVariantFilters', properties);
      renderVariantFilters('effectsVariantFilters', properties);
    }

    // Get selected properties for a section
    function getSelectedPropsForSection(containerId) {
      const selected = {};
      document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`).forEach(cb => {
        const prop = cb.dataset.property;
        const value = cb.dataset.value;
        if (prop && value) {
          if (!selected[prop]) selected[prop] = [];
          selected[prop].push(value);
        }
      });
      return selected;
    }

    // Get all selected options
    function getSelectedOptions() {
      return {
        // Sections
        sectionColors: document.getElementById('sectionColors').checked,
        sectionText: document.getElementById('sectionText').checked,
        sectionSpacing: document.getElementById('sectionSpacing').checked,
        sectionEffects: document.getElementById('sectionEffects').checked,
        sectionComponents: document.getElementById('sectionComponents').checked,
        sectionEstados: document.getElementById('sectionEstados').checked,
        sectionProperties: document.getElementById('sectionProperties').checked,
        // Settings
        frameWidth: parseInt(document.getElementById('frameWidth').value) || 1140,
        paddingHorizontal: parseInt(document.getElementById('paddingHorizontal').value) || 64,
        sectionSpacingValue: parseInt(document.getElementById('sectionSpacingInput').value) || 48,
        bgColor: document.getElementById('bgColor').value || 'FFFFFF',
        // Visualization mode
        highlightMode: document.getElementById('highlightMode').checked,
        // View modes (table/canvas)
        textShowTable: viewModes.text.table,
        textShowViz: viewModes.text.canvas,
        spacingShowTable: viewModes.spacing.table,
        spacingShowViz: viewModes.spacing.canvas,
        effectsShowTable: viewModes.effects.table,
        effectsShowViz: viewModes.effects.canvas,
        // Visualization property filters (per section)
        textVizProperties: getSelectedPropsForSection('textVariantFilters'),
        spacingVizProperties: getSelectedPropsForSection('spacingVariantFilters'),
        effectsVizProperties: getSelectedPropsForSection('effectsVariantFilters'),
        // Frames per row
        textFramesPerRow: parseInt(document.getElementById('textFramesPerRow').value) || 2,
        spacingFramesPerRow: parseInt(document.getElementById('spacingFramesPerRow').value) || 2,
        effectsFramesPerRow: parseInt(document.getElementById('effectsFramesPerRow').value) || 2,
        // Estados grid density
        gridDensity: parseInt(document.getElementById('gridDensity').value) || 4
      };
    }

    // Selected asset state
    let selectedAssetType = 'measure';

    // Select asset card
    window.selectAsset = function selectAsset(element, assetType) {
      // Remove selected from all cards
      document.querySelectorAll('.asset-card').forEach(card => {
        card.classList.remove('selected');
      });
      // Add selected to clicked card
      element.classList.add('selected');
      selectedAssetType = assetType;

      // Show/hide appropriate options sections
      const isPointer = assetType.startsWith('pointer-');
      const isNumber = assetType.startsWith('number-');
      const isArea = assetType.startsWith('area-');
      const isApoio = isNumber || isArea;
      const medidasSection = document.getElementById('medidasOptions');
      const pointersSection = document.getElementById('pointersOptions');
      const apoioSection = document.getElementById('apoioOptions');

      if (isPointer) {
        medidasSection.style.display = 'none';
        pointersSection.style.display = 'block';
        apoioSection.style.display = 'none';
      } else if (isApoio) {
        // Assets de APOIO têm opção de variante
        medidasSection.style.display = 'none';
        pointersSection.style.display = 'none';
        apoioSection.style.display = 'block';

        // Preencher select de variantes baseado no tipo
        const variantSelect = document.getElementById('apoioVariant');
        variantSelect.innerHTML = '';

        if (isNumber) {
          variantSelect.innerHTML = `
            <option value="number-top">Top</option>
            <option value="number-bottom">Bottom</option>
            <option value="number-left">Left</option>
            <option value="number-right">Right</option>
          `;
          variantSelect.value = assetType;
        } else if (isArea) {
          variantSelect.innerHTML = `
            <option value="area-dashed-circle">Dashed Circle</option>
            <option value="area-dashed-square">Dashed Square</option>
            <option value="area-solid-circle">Solid Circle</option>
            <option value="area-solid-square">Solid Square</option>
          `;
          variantSelect.value = assetType;
        }

        // Listener para trocar variante
        variantSelect.onchange = function() {
          const newType = this.value;
          selectedAssetType = newType;
          const newCard = document.querySelector(`[data-asset="${newType}"]`);
          if (newCard) {
            document.querySelectorAll('.asset-card').forEach(c => c.classList.remove('selected'));
            newCard.classList.add('selected');
          }
          if (isEditingMarker) {
            triggerMarkerUpdate();
          }
        };
      } else {
        medidasSection.style.display = 'block';
        pointersSection.style.display = 'none';
        apoioSection.style.display = 'none';
      }

      // If editing, trigger update
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }

    // Trigger marker update when properties change
    function triggerMarkerUpdate() {
      if (!isEditingMarker) return;

      const isPointer = selectedAssetType.startsWith('pointer-');
      const isNumber = selectedAssetType.startsWith('number-');
      const isArea = selectedAssetType.startsWith('area-');
      const isApoio = isNumber || isArea;

      let value, color, direction, badgePosition, size, textColorType;

      if (isApoio) {
        // Assets de APOIO usam valores padrão
        if (isNumber) {
          value = '1';
          size = 25;
          // Get color from button or input
          const colorBtn = document.getElementById('apoioNumberColorBtn');
          const customInput = document.getElementById('apoioNumberCustomHex');
          let customHex = customInput ? customInput.value.trim() : '';

          if (customHex) {
            // Add # if not present
            if (!customHex.startsWith('#')) {
              customHex = '#' + customHex;
            }
            if (/^#[0-9A-Fa-f]{6}$/.test(customHex)) {
              color = customHex;
            }
          }

          if (!customHex || !/^#[0-9A-Fa-f]{6}$/.test(customHex)) {
            if (colorBtn) {
              const bgColor = colorBtn.style.background;
              if (bgColor.startsWith('rgb')) {
                const rgb = bgColor.match(/\d+/g);
                if (rgb) {
                  color = '#' + rgb.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
                }
              } else if (bgColor.startsWith('#')) {
                color = bgColor;
              } else {
                color = '#FCFC30';
              }
            } else {
              color = '#FCFC30';
            }
          }
        } else if (isArea) {
          value = '';
          // Outline assets are 28x28, others are 48x48
          const isOutline = selectedAssetType.includes('outline');
          size = isOutline ? 28 : 48;

          // Get color from button or input
          const colorBtn = document.getElementById('apoioAreaColorBtn');
          const customInput = document.getElementById('apoioAreaCustomHex');
          let customHex = customInput ? customInput.value.trim() : '';

          if (customHex) {
            // Add # if not present
            if (!customHex.startsWith('#')) {
              customHex = '#' + customHex;
            }
            if (/^#[0-9A-Fa-f]{6}$/.test(customHex)) {
              color = customHex;
            }
          }

          if (!customHex || !/^#[0-9A-Fa-f]{6}$/.test(customHex)) {
            if (colorBtn) {
              const bgColor = colorBtn.style.background;
              if (bgColor.startsWith('rgb')) {
                const rgb = bgColor.match(/\d+/g);
                if (rgb) {
                  color = '#' + rgb.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
                }
              } else if (bgColor.startsWith('#')) {
                color = bgColor;
              } else {
                color = '#DAA0B0';
              }
            } else {
              color = '#DAA0B0';
            }
          }
        }
        direction = 'horizontal';
        badgePosition = 'bottom';
      } else if (isPointer) {
        // Use pointer color picker
        const markerColorPicker = document.getElementById('pointerMarkerColorPicker');
        const textColorSelect = document.getElementById('pointerTextColorSelect');
        const textCustomHex = document.getElementById('pointerTextCustomHex');

        // Use existing value if editing, otherwise default to 'caption'
        if (isEditingMarker && currentMarkerConfig && currentMarkerConfig.value) {
          value = currentMarkerConfig.value;
        } else {
          value = 'caption';
        }
        badgePosition = selectedAssetType.replace('pointer-', '');

        // Get marker color from picker
        color = markerColorPicker ? markerColorPicker.value : '#e11d48';

        // Get text color
        if (textColorSelect && textColorSelect.value === 'custom') {
          let customValue = textCustomHex ? textCustomHex.value.trim() : '';
          if (customValue) {
            // Add # if not present
            if (!customValue.startsWith('#')) {
              customValue = '#' + customValue;
            }
            if (/^#[0-9A-Fa-f]{6}$/.test(customValue)) {
              textColorType = customValue;
            } else {
              textColorType = 'inherit';
            }
          } else {
            textColorType = 'inherit';
          }
        } else {
          textColorType = textColorSelect ? textColorSelect.value : 'inherit';
        }

        direction = undefined;
        size = 40;
      } else {
        // Measure/gap/padding fields
        const assetDirectionEl = document.getElementById('assetDirection');
        const assetBadgePositionEl = document.getElementById('assetBadgePosition');
        const colorPicker = document.getElementById('medidasColorPicker');

        value = '0px'; // Show 0px for measures
        color = colorPicker ? colorPicker.value : '#E3111F';
        direction = assetDirectionEl ? assetDirectionEl.value || 'horizontal' : 'horizontal';
        badgePosition = assetBadgePositionEl ? assetBadgePositionEl.value || 'bottom' : 'bottom';
        size = 40;
      }

      const highlightModeEl = document.getElementById('assetHighlightMode');
      const highlightMode = highlightModeEl ? highlightModeEl.checked || false : false;

      const markerConfig = {
        type: selectedAssetType,
        direction: direction,
        value: value,
        colorType: color,
        textColorType: textColorType,
        badgePosition: badgePosition,
        highlightMode: highlightMode,
        size: size
      };

      parent.postMessage({
        pluginMessage: {
          type: 'update-marker',
          markerConfig: markerConfig
        }
      }, '*');
    }

    // Color preview helpers
    const colorMap = {
      'red': '#ff3333',
      'blue': '#0080ff',
      'pink': '#ec4899',
      'green': '#2ec770',
      'black': '#000000',
      'inherit': '#2ec770'
    };

    function updateColorPreviews() {
      const markerColorEl = document.getElementById('pointerMarkerColor');
      const textColorEl = document.getElementById('pointerTextColor');

      if (!markerColorEl || !textColorEl) return;

      const markerColor = markerColorEl.value;
      const textColor = textColorEl.value;

      const markerPreview = document.getElementById('markerColorPreview');
      const textPreview = document.getElementById('textColorPreview');

      if (markerPreview) {
        markerPreview.style.background = colorMap[markerColor] || '#2ec770';
      }

      if (textPreview) {
        const finalTextColor = textColor === 'inherit' ? markerColor : textColor;
        textPreview.style.background = colorMap[finalTextColor] || '#2ec770';
      }
    }

    // Add change listeners to inputs for live updates
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize: Show medidas by default, hide pointers and apoio
      const medidasOptions = document.getElementById('medidasOptions');
      const pointersOptions = document.getElementById('pointersOptions');
      const apoioOptions = document.getElementById('apoioOptions');

      if (medidasOptions) medidasOptions.style.display = 'grid';
      if (pointersOptions) pointersOptions.style.display = 'none';
      if (apoioOptions) apoioOptions.style.display = 'none';

      // Initialize color previews
      updateColorPreviews();

      // Medidas listeners
      const assetSize = document.getElementById('assetSize');
      const assetDirection = document.getElementById('assetDirection');
      const assetBadgePosition = document.getElementById('assetBadgePosition');

      if (assetSize) {
        assetSize.addEventListener('change', () => {
          if (isEditingMarker) triggerMarkerUpdate();
        });
      }
      if (assetDirection) {
        assetDirection.addEventListener('change', () => {
          if (isEditingMarker) triggerMarkerUpdate();
        });
      }
      if (assetBadgePosition) {
        assetBadgePosition.addEventListener('change', () => {
          if (isEditingMarker) triggerMarkerUpdate();
        });
      }

      // Pointers listeners
      const pointerPosition = document.getElementById('pointerPosition');
      const pointerMarkerColor = document.getElementById('pointerMarkerColor');
      const pointerTextColor = document.getElementById('pointerTextColor');

      if (pointerPosition) {
        pointerPosition.addEventListener('change', () => {
          if (isEditingMarker) triggerMarkerUpdate();
        });
      }
      if (pointerMarkerColor) {
        pointerMarkerColor.addEventListener('change', () => {
          updateColorPreviews();
          if (isEditingMarker) triggerMarkerUpdate();
        });
      }
      if (pointerTextColor) {
        pointerTextColor.addEventListener('change', () => {
          updateColorPreviews();
          if (isEditingMarker) triggerMarkerUpdate();
        });
      }

      // Global listeners
      const assetHighlightMode = document.getElementById('assetHighlightMode');
      if (assetHighlightMode) {
        assetHighlightMode.addEventListener('change', () => {
          if (isEditingMarker) triggerMarkerUpdate();
        });
      }
    });

    // Function moved up to handle both insert and update

    // Legacy insert asset (kept for compatibility)
    function insertAsset(assetType) {
      const value = document.getElementById('assetValue').value || '0px';
      const color = document.getElementById('assetColor').value || 'red';
      const direction = document.getElementById('assetDirection').value || 'horizontal';
      const badgePosition = document.getElementById('assetBadgePosition').value || 'bottom';
      const highlightMode = document.getElementById('assetHighlightMode').checked || false;

      parent.postMessage({
        pluginMessage: {
          type: 'insert-asset',
          assetType: assetType,
          value: value,
          color: color,
          direction: direction,
          badgePosition: badgePosition,
          highlightMode: highlightMode
        }
      }, '*');
    }

    // Close plugin
    window.closePlugin = function closePlugin() {
      parent.postMessage({ pluginMessage: { type: 'close' } }, '*');
    }

    // Refresh plugin
    window.refreshPlugin = function refreshPlugin() {
      parent.postMessage({ pluginMessage: { type: 'refresh' } }, '*');
    }

    // Generate specifications
    window.generate = function generate() {
      const options = getSelectedOptions();

      // Check if at least one section is selected
      const hasSelection = options.sectionColors || options.sectionText ||
        options.sectionSpacing || options.sectionEffects || options.sectionComponents ||
        options.sectionEstados || options.sectionProperties;

      if (!hasSelection) {
        alert('Selecione pelo menos uma seção para gerar.');
        return;
      }

      parent.postMessage({ pluginMessage: { type: 'generate', options } }, '*');
    }

    // Load marker config into UI
    function loadMarkerConfig(config) {
      isEditingMarker = true;
      currentMarkerConfig = config;

      // Switch to Assets tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.querySelector('[data-tab="assets"]').classList.add('active');
      document.getElementById('assets').classList.add('active');

      // Hide footer in assets tab
      document.querySelector('.footer').style.display = 'none';

      // Show editing banner
      document.getElementById('editingBanner').classList.add('active');

      // Populate fields based on marker type
      const isPointer = config.type.startsWith('pointer-');
      const isNumber = config.type.startsWith('number-');
      const isArea = config.type.startsWith('area-');
      const isApoio = isNumber || isArea;

      const medidasOptions = document.getElementById('medidasOptions');
      const pointersOptions = document.getElementById('pointersOptions');

      if (isPointer) {
        // Load pointer color settings
        const markerColorPicker = document.getElementById('pointerMarkerColorPicker');
        const textColorSelect = document.getElementById('pointerTextColorSelect');
        const textCustomHex = document.getElementById('pointerTextCustomHex');
        const textCustomWrapper = document.getElementById('pointerTextCustomWrapper');

        // Load marker color
        if (config.colorType) {
          if (markerColorPicker) markerColorPicker.value = config.colorType.startsWith('#') ? config.colorType : '#e11d48';
        }

        // Check if textColorType is hex
        if (config.textColorType && config.textColorType.startsWith('#')) {
          textColorSelect.value = 'custom';
          textCustomHex.value = config.textColorType.substring(1);
          textCustomWrapper.classList.add('visible');
        } else {
          textColorSelect.value = config.textColorType || 'inherit';
          textCustomWrapper.classList.remove('visible');
        }

        medidasOptions.style.display = 'none';
        pointersOptions.style.display = 'grid';
      } else if (isApoio) {
        // For APOIO items, set the appropriate select values
        if (isNumber) {
          const numberDirection = document.getElementById('apoioNumberDirection');
          if (numberDirection) numberDirection.value = config.type;

          // Load color if hex
          if (config.colorType && config.colorType.startsWith('#')) {
            const colorBtn = document.getElementById('apoioNumberColorBtn');
            const customHex = document.getElementById('apoioNumberCustomHex');
            if (colorBtn) colorBtn.style.background = config.colorType;
            if (customHex) customHex.value = config.colorType;
          }
        } else if (isArea) {
          const areaType = document.getElementById('apoioAreaType');
          if (areaType) areaType.value = config.type;

          // Load color if hex
          if (config.colorType && config.colorType.startsWith('#')) {
            const colorBtn = document.getElementById('apoioAreaColorBtn');
            const customHex = document.getElementById('apoioAreaCustomHex');
            if (colorBtn) colorBtn.style.background = config.colorType;
            if (customHex) customHex.value = config.colorType;
          }
        }

        medidasOptions.style.display = 'none';
        pointersOptions.style.display = 'none';
      } else {
        // Measure/gap/padding fields
        const assetDirection = document.getElementById('assetDirection');
        const assetBadgePosition = document.getElementById('assetBadgePosition');
        const colorPicker = document.getElementById('medidasColorPicker');

        if (assetDirection) assetDirection.value = config.direction || 'horizontal';
        if (assetBadgePosition) assetBadgePosition.value = config.badgePosition || 'bottom';

        // Load color if hex
        if (config.colorType && config.colorType.startsWith('#')) {
          if (colorPicker) colorPicker.value = config.colorType;
        }

        medidasOptions.style.display = 'grid';
        pointersOptions.style.display = 'none';
      }

      document.getElementById('assetHighlightMode').checked = config.highlightMode;

      // Select the appropriate asset card
      const assetCard = document.querySelector(`[data-asset="${config.type}"]`);
      if (assetCard) {
        document.querySelectorAll('.asset-card').forEach(card => card.classList.remove('selected'));
        assetCard.classList.add('selected');
        selectedAssetType = config.type;
      }

      // Change button text to "Atualizar"
      const addLink = document.querySelector('.assets-add-link');
      if (addLink) {
        addLink.textContent = '✏️ Atualizar Marcador';
        addLink.style.background = 'linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%)';
        addLink.style.color = 'white';
      }
    }

    // Reset editing state
    function resetMarkerEditingState() {
      isEditingMarker = false;
      currentMarkerConfig = null;

      // Hide editing banner
      document.getElementById('editingBanner').classList.remove('active');

      // Reset button
      const addLink = document.querySelector('.assets-add-link');
      addLink.textContent = 'Adicionar asset no arquivo';
      addLink.style.background = 'var(--accent-light)';
      addLink.style.color = 'var(--accent)';
    }

    // Update insertSelectedAsset to handle both create and update
    window.insertSelectedAsset = function insertSelectedAsset() {
      const isPointer = selectedAssetType.startsWith('pointer-');
      const isNumber = selectedAssetType.startsWith('number-');
      const isArea = selectedAssetType.startsWith('area-');
      const isApoio = isNumber || isArea;

      let value, color, direction, badgePosition, size;

      if (isPointer) {
        // Use pointer-specific fields
        const pointerValueField = document.getElementById('pointerValue');
        const pointerMarkerColorField = document.getElementById('pointerMarkerColor');

        value = pointerValueField ? pointerValueField.value : 'caption';
        // Extract position from selectedAssetType (pointer-top -> top)
        badgePosition = selectedAssetType.replace('pointer-', '');
        color = pointerMarkerColorField ? pointerMarkerColorField.value : 'green';
        direction = undefined;
        size = undefined;
      } else if (isApoio) {
        // Assets de APOIO usam valores padrão baseados no tipo
        if (isNumber) {
          value = '1';
          size = 25;
        } else if (isArea) {
          value = '28px';
          size = 28;
        }
        color = undefined;
        direction = undefined;
        badgePosition = undefined;
      } else {
        // Use measure/gap/padding fields
        const assetDirectionField = document.getElementById('assetDirection');
        const assetBadgePositionField = document.getElementById('assetBadgePosition');
        const assetSizeField = document.getElementById('assetSize');

        direction = assetDirectionField ? assetDirectionField.value : 'horizontal';
        badgePosition = assetBadgePositionField ? assetBadgePositionField.value : 'bottom';
        size = assetSizeField ? parseInt(assetSizeField.value) : 100;

        // Generate value automatically from size
        value = size + 'px';

        // Set color based on asset type
        if (selectedAssetType === 'gap') {
          color = 'pink';
        } else if (selectedAssetType === 'padding') {
          color = 'blue';
        } else {
          color = 'red';
        }
      }

      const highlightMode = document.getElementById('assetHighlightMode').checked || false;

      if (isEditingMarker) {
        // Update existing marker
        const markerConfig = {
          type: selectedAssetType,
          direction: direction,
          value: value,
          colorType: color,
          badgePosition: badgePosition,
          highlightMode: highlightMode,
          size: size
        };

        parent.postMessage({
          pluginMessage: {
            type: 'update-marker',
            markerConfig: markerConfig
          }
        }, '*');

        resetMarkerEditingState();
      } else {
        // Insert new asset
        parent.postMessage({
          pluginMessage: {
            type: 'insert-asset',
            assetType: selectedAssetType,
            value: value,
            color: color,
            direction: direction,
            badgePosition: badgePosition,
            highlightMode: highlightMode,
            size: size
          }
        }, '*');
      }
    }

    // Listen for messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'marker-selected') {
        // Marker selected - load config
        loadMarkerConfig(msg.config);
      } else if (msg.type === 'marker-deselected') {
        // No marker selected - reset state
        resetMarkerEditingState();
      } else if (msg.type === 'selection-info') {
        document.getElementById('componentName').textContent = msg.text || 'Selecione um componente';
        document.getElementById('componentType').textContent = '-';
        // Reset icon
        const headerIcon = document.getElementById('headerIcon');
        headerIcon.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>`;
      } else if (msg.type === 'init') {
        // Update component name in header
        if (msg.componentName) {
          document.getElementById('componentName').textContent = msg.componentName;

          // Update icon and type based on nodeType
          const headerIcon = document.getElementById('headerIcon');
          let typeText = 'Componente';
          let iconHTML = '❖'; // Default component icon

          if (msg.nodeType === 'INSTANCE') {
            typeText = 'Instância';
            iconHTML = '◇';
          } else if (msg.nodeType === 'COMPONENT_SET' || msg.componentName.includes('/')) {
            typeText = 'Conjunto de Componentes';
            iconHTML = '❖';
          } else if (msg.nodeType === 'COMPONENT') {
            typeText = 'Componente';
            iconHTML = '❖';
          }

          headerIcon.textContent = iconHTML;
          document.getElementById('componentType').textContent = typeText;
        }
        // Render variant properties if available
        if (msg.variantProperties) {
          renderVariantProperties(msg.variantProperties);
        }
      }
    };

    // === NEW COMPACT UI FUNCTIONS ===

    // Select asset and show/hide relevant controls
    function selectCompactAsset(assetType, btnElement) {
      // Update selected state
      document.querySelectorAll('.compact-asset-btn').forEach(btn => btn.classList.remove('selected'));
      btnElement.classList.add('selected');
      selectedAssetType = assetType;

      // Show/hide controls based on asset type
      const medidasOptions = document.getElementById('medidasOptions');
      const pointersOptions = document.getElementById('pointersOptions');
      const addAssetButton = document.getElementById('addAssetButtonContainer');
      const isPointer = assetType.startsWith('pointer-');
      const isMedida = ['measure', 'gap', 'padding'].includes(assetType);

      if (isMedida) {
        medidasOptions.style.display = 'grid';
        pointersOptions.style.display = 'none';
        addAssetButton.style.display = 'block';
      } else if (isPointer) {
        medidasOptions.style.display = 'none';
        pointersOptions.style.display = 'grid';
        addAssetButton.style.display = 'block';
      } else {
        medidasOptions.style.display = 'none';
        pointersOptions.style.display = 'none';
        addAssetButton.style.display = 'none';
      }

      // Trigger update if editing
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }

    // Insert selected asset (for Medidas/Pointers)
    function insertCompactAsset() {
      const isPointer = selectedAssetType.startsWith('pointer-');
      const isMedida = ['measure', 'gap', 'padding'].includes(selectedAssetType);

      if (!selectedAssetType) {
        alert('Selecione um asset primeiro');
        return;
      }

      const highlightMode = document.getElementById('assetHighlightMode').checked;

      if (isMedida) {
        const direction = document.getElementById('assetDirection').value;
        const badgePosition = document.getElementById('assetBadgePosition').value;

        // Get color from picker
        const colorPicker = document.getElementById('medidasColorPicker');
        const color = colorPicker ? colorPicker.value : '#E3111F';

        parent.postMessage({
          pluginMessage: {
            type: 'insert-asset',
            assetType: selectedAssetType,
            value: '0px',
            color: color,
            direction: direction,
            badgePosition: badgePosition,
            highlightMode: highlightMode,
            size: 40
          }
        }, '*');
      } else if (isPointer) {
        const markerColorPicker = document.getElementById('pointerMarkerColorPicker');
        const textColorSelect = document.getElementById('pointerTextColorSelect');
        const textCustomHex = document.getElementById('pointerTextCustomHex');

        const markerColor = markerColorPicker ? markerColorPicker.value : '#e11d48';

        let textColor = textColorSelect.value;
        if (textColorSelect.value === 'custom') {
          let customValue = textCustomHex.value.trim();
          if (customValue) {
            // Add # if not present
            if (!customValue.startsWith('#')) {
              customValue = '#' + customValue;
            }
            if (/^#[0-9A-Fa-f]{6}$/.test(customValue)) {
              textColor = customValue;
            }
          }
        }

        parent.postMessage({
          pluginMessage: {
            type: 'insert-asset',
            assetType: selectedAssetType,
            value: 'caption',
            color: markerColor,
            textColor: textColor,
            direction: 'horizontal',
            badgePosition: 'bottom',
            highlightMode: highlightMode,
            size: 40
          }
        }, '*');
      }
    }

    function onPointerMarkerColorChange() {
      const select = document.getElementById('pointerMarkerColorSelect');
      const customWrapper = document.getElementById('pointerMarkerCustomWrapper');
      const preview = document.getElementById('pointerMarkerColorPreview');

      if (select.value === 'custom') {
        customWrapper.classList.add('visible');
      } else {
        customWrapper.classList.remove('visible');
        // Update preview based on preset
        const colorMap = {
          red: '#e11d48',
          blue: '#3b82f6',
          pink: '#ec4899',
          green: '#10b981'
        };
        preview.style.background = colorMap[select.value] || '#e11d48';
      }

      // Trigger update if editing
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }

    function onPointerMarkerColorPickerChange() {
      // Trigger update if editing
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }

    function onPointerMarkerCustomInput() {
      const input = document.getElementById('pointerMarkerCustomHex');
      const picker = document.getElementById('pointerMarkerColorPicker');
      let hex = input.value.trim().toUpperCase();

      // Remove # if user typed it
      if (hex.startsWith('#')) {
        hex = hex.substring(1);
        input.value = hex;
      }

      if (hex && /^[0-9A-Fa-f]{6}$/.test(hex)) {
        const fullHex = '#' + hex;
        picker.value = fullHex;

        // Trigger update if editing
        if (isEditingMarker) {
          triggerMarkerUpdate();
        }
      }
    }

    function onPointerTextColorChange() {
      const select = document.getElementById('pointerTextColorSelect');
      const customWrapper = document.getElementById('pointerTextCustomWrapper');
      const preview = document.getElementById('pointerTextColorPreview');
      const markerPreview = document.getElementById('pointerMarkerColorPreview');

      if (select.value === 'custom') {
        customWrapper.classList.add('visible');
      } else {
        customWrapper.classList.remove('visible');
        if (select.value === 'inherit') {
          preview.style.background = markerPreview.style.background;
        } else if (select.value === 'black') {
          preview.style.background = '#000000';
        }
      }

      // Trigger update if editing
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }

    function onPointerTextColorPickerChange() {
      const picker = document.getElementById('pointerTextColorPicker');
      const input = document.getElementById('pointerTextCustomHex');
      const preview = document.getElementById('pointerTextColorPreview');

      const hex = picker.value;
      input.value = hex.substring(1).toUpperCase();
      preview.style.background = hex;

      // Trigger update if editing
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }

    function onPointerTextCustomInput() {
      const input = document.getElementById('pointerTextCustomHex');
      const picker = document.getElementById('pointerTextColorPicker');
      const preview = document.getElementById('pointerTextColorPreview');
      let hex = input.value.trim().toUpperCase();

      // Remove # if user typed it
      if (hex.startsWith('#')) {
        hex = hex.substring(1);
        input.value = hex;
      }

      if (hex && /^[0-9A-Fa-f]{6}$/.test(hex)) {
        const fullHex = '#' + hex;
        preview.style.background = fullHex;
        picker.value = fullHex;

        // Trigger update if editing
        if (isEditingMarker) {
          triggerMarkerUpdate();
        }
      }
    }

    // APOIO - Number Functions
    function updateApoioNumberSelection() {
      const select = document.getElementById('apoioNumberDirection');
      selectedAssetType = select.value;

      // Update data-asset attribute for compatibility
      select.setAttribute('data-asset', select.value);

      // Trigger update if editing
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }

    function toggleApoioNumberColorPicker() {
      const wrapper = document.getElementById('apoioNumberCustomWrapper');
      wrapper.classList.toggle('visible');
    }

    function onApoioNumberColorPickerChange() {
      const picker = document.getElementById('apoioNumberColorPicker');
      const input = document.getElementById('apoioNumberCustomHex');
      const btn = document.getElementById('apoioNumberColorBtn');

      const hex = picker.value;
      input.value = hex.substring(1).toUpperCase();
      btn.style.background = hex;

      // Trigger update if editing
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }

    function onApoioNumberCustomInput() {
      const input = document.getElementById('apoioNumberCustomHex');
      const picker = document.getElementById('apoioNumberColorPicker');
      const btn = document.getElementById('apoioNumberColorBtn');
      let hex = input.value.trim().toUpperCase();

      // Remove # if user typed it
      if (hex.startsWith('#')) {
        hex = hex.substring(1);
        input.value = hex;
      }

      if (hex && /^[0-9A-Fa-f]{6}$/.test(hex)) {
        const fullHex = '#' + hex;
        btn.style.background = fullHex;
        picker.value = fullHex;

        // Trigger update if editing
        if (isEditingMarker) {
          triggerMarkerUpdate();
        }
      }
    }

    function insertApoioNumber() {
      const direction = document.getElementById('apoioNumberDirection').value;
      const colorBtn = document.getElementById('apoioNumberColorBtn');
      const customInput = document.getElementById('apoioNumberCustomHex');
      const highlightMode = document.getElementById('assetHighlightMode').checked;

      let color = '#FCFC30'; // Default yellow
      let customHex = customInput.value.trim();
      if (customHex) {
        // Add # if not present
        if (!customHex.startsWith('#')) {
          customHex = '#' + customHex;
        }
        if (/^#[0-9A-Fa-f]{6}$/.test(customHex)) {
          color = customHex;
        }
      }

      if (!customHex || !/^#[0-9A-Fa-f]{6}$/.test(customHex)) {
        // Use the button's background color
        const bgColor = colorBtn.style.background;
        if (bgColor.startsWith('rgb')) {
          // Convert rgb to hex if needed
          const rgb = bgColor.match(/\d+/g);
          if (rgb) {
            color = '#' + rgb.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
          }
        } else if (bgColor.startsWith('#')) {
          color = bgColor;
        }
      }

      parent.postMessage({
        pluginMessage: {
          type: 'insert-asset',
          assetType: direction,
          value: '1', // Number 1 instead of 0px
          color: color,
          direction: 'horizontal',
          badgePosition: 'bottom',
          highlightMode: highlightMode,
          size: 25
        }
      }, '*');
    }

    // APOIO - Area Functions
    function updateApoioAreaSelection() {
      const select = document.getElementById('apoioAreaType');
      selectedAssetType = select.value;

      // Update data-asset attribute for compatibility
      select.setAttribute('data-asset', select.value);

      // Trigger update if editing
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }

    function toggleApoioAreaColorPicker() {
      const wrapper = document.getElementById('apoioAreaCustomWrapper');
      wrapper.classList.toggle('visible');
    }

    function onApoioAreaColorPickerChange() {
      const picker = document.getElementById('apoioAreaColorPicker');
      const input = document.getElementById('apoioAreaCustomHex');
      const btn = document.getElementById('apoioAreaColorBtn');

      const hex = picker.value;
      input.value = hex.substring(1).toUpperCase();
      btn.style.background = hex;

      // Trigger update if editing
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }

    function onApoioAreaCustomInput() {
      const input = document.getElementById('apoioAreaCustomHex');
      const picker = document.getElementById('apoioAreaColorPicker');
      const btn = document.getElementById('apoioAreaColorBtn');
      let hex = input.value.trim().toUpperCase();

      // Remove # if user typed it
      if (hex.startsWith('#')) {
        hex = hex.substring(1);
        input.value = hex;
      }

      if (hex && /^[0-9A-Fa-f]{6}$/.test(hex)) {
        const fullHex = '#' + hex;
        btn.style.background = fullHex;
        picker.value = fullHex;

        // Trigger update if editing
        if (isEditingMarker) {
          triggerMarkerUpdate();
        }
      }
    }

    function insertApoioArea() {
      const areaType = document.getElementById('apoioAreaType').value;
      const colorBtn = document.getElementById('apoioAreaColorBtn');
      const customInput = document.getElementById('apoioAreaCustomHex');
      const highlightMode = document.getElementById('assetHighlightMode').checked;

      // Outline assets are 28x28, others are 48x48
      const isOutline = areaType.includes('outline');
      const size = isOutline ? 28 : 48;

      let color = '#DAA0B0'; // Default pink
      let customHex = customInput.value.trim();
      if (customHex) {
        // Add # if not present
        if (!customHex.startsWith('#')) {
          customHex = '#' + customHex;
        }
        if (/^#[0-9A-Fa-f]{6}$/.test(customHex)) {
          color = customHex;
        }
      }

      if (!customHex || !/^#[0-9A-Fa-f]{6}$/.test(customHex)) {
        // Use the button's background color
        const bgColor = colorBtn.style.background;
        if (bgColor.startsWith('rgb')) {
          // Convert rgb to hex if needed
          const rgb = bgColor.match(/\d+/g);
          if (rgb) {
            color = '#' + rgb.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
          }
        } else if (bgColor.startsWith('#')) {
          color = bgColor;
        }
      }

      parent.postMessage({
        pluginMessage: {
          type: 'insert-asset',
          assetType: areaType,
          value: '', // No value for areas
          color: color,
          direction: 'horizontal',
          badgePosition: 'bottom',
          highlightMode: highlightMode,
          size: size
        }
      }, '*');
    }

    // MEDIDAS - Color Functions
    function onMedidasColorPickerChange() {
      // Trigger update if editing
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }

    // Global Highlight Toggle
    function toggleGlobalHighlight() {
      const checkbox = document.getElementById('assetHighlightMode');
      checkbox.checked = !checkbox.checked;

      // Trigger update if editing
      if (isEditingMarker) {
        triggerMarkerUpdate();
      }
    }
  </script>
</body>

</html>
